<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Savings</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/savings.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="container">

  <!-- BACK TO DASHBOARD -->
  <div style="text-align:right; margin-bottom:20px;">
    <a href="{{ url_for('dashboard') }}" class="back-dashboard-btn">
      Back to Dashboard
    </a>
  </div>

  <!-- HEADER -->
  <h1 class="title">Savings Calculator</h1>
  <p class="subtitle">Savings = Total Income âˆ’ Total Expenses</p>

  <!-- SUMMARY CARDS -->
  <div class="summary-cards">

    <!-- âœ… INCOME CARD (CLICKABLE VIA JS) -->
    <div class="summary-card income" onclick="goIncome()" style="cursor:pointer;">
      <div class="icon-box">
        <img src="{{ url_for('static', filename='images/income.png') }}">
      </div>
      <div class="text">
        <p>Income</p>
        <h3 id="incomeValue">â‚¹ 0</h3>
      </div>
    </div>

    <!-- âœ… EXPENSE CARD (CLICKABLE VIA JS) -->
    <div class="summary-card expense" onclick="goExpense()" style="cursor:pointer;">
      <div class="icon-box">
        <img src="{{ url_for('static', filename='images/expense.png') }}">
      </div>
      <div class="text">
        <p>Expenses</p>
        <h3 id="expenseValue">â‚¹ 0</h3>
      </div>
    </div>

    <!-- âŒ SAVINGS CARD (NOT CLICKABLE) -->
    <div class="summary-card saving">
      <div class="icon-box">
        <img src="{{ url_for('static', filename='images/saving.png') }}">
      </div>
      <div class="text">
        <p>Savings</p>
        <h3 id="savingValue">â‚¹ 0</h3>
      </div>
    </div>

  </div>

  <h2>Monthly Savings Summary</h2>

  <!-- RANGE TOGGLE (UNCHANGED) -->
  <div class="range-toggle">
    <button class="range-btn" onclick="changeRange('month', this)">This Month</button>
    <button class="range-btn active" onclick="changeRange('6months', this)">Last 6 Months</button>
    <button class="range-btn" onclick="changeRange('year', this)">Year</button>
  </div>

  <!-- MONTHLY + INSIGHT -->
  <div class="monthly">
    <div class="monthly-left">
      <h2 id="monthLabel">Monthly Savings</h2>
      <h1 id="monthSaving">â€”</h1>
      <p id="savingRate"></p>
    </div>

    <div class="monthly-right">
      <h2>âš  Insight</h2>
      <p id="insightText">Savings depend on income & expense trend</p>
    </div>
  </div>

  <!-- CHART -->
  <div class="chart-box">
    <h1>Monthly Savings Trends</h1>
    <canvas id="savingsChart"></canvas>
  </div>

</div>

<!-- ================= JAVASCRIPT ================= -->
<script>
/* ================= CARD NAVIGATION (ONLY ADDITION) ================= */
function goIncome() {
  window.location.href = "{{ url_for('income_summary') }}";
}

function goExpense() {
  window.location.href = "{{ url_for('expense_management') }}";
}

/* ================= YOUR ORIGINAL LOGIC ================= */
let chart;

function changeRange(range, btn) {
  document.querySelectorAll(".range-btn").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  loadSavings(range);
}

function loadSavings(range) {
  fetch(`/api/savings/${range}`)
    .then(res => res.json())
    .then(data => {

      incomeValue.innerText  = "â‚¹ " + data.income.toLocaleString();
      expenseValue.innerText = "â‚¹ " + data.expense.toLocaleString();
      savingValue.innerText  = "â‚¹ " + data.savings.toLocaleString();

      if (!data.labels || data.labels.length === 0) {
        monthLabel.innerText = "No Data";
        monthSaving.innerText = "â‚¹ 0";
        savingRate.innerText = "Savings Rate: 0%";
        insightText.innerText = "No data available for this period";
        return;
      }

      const last = data.labels.length - 1;
      let currentSavings = 0;
      let currentIncome  = 0;

      if (range === "month") {
        currentSavings = data.savings_list[last] || 0;
        currentIncome  = data.incomes[last] || 0;
      } else {
        currentSavings = data.savings_list.reduce((a, b) => a + (b || 0), 0);
        currentIncome  = data.incomes.reduce((a, b) => a + (b || 0), 0);
      }

      const currentLabel = data.labels[last];

      if (range === "month") {
        const [y, m] = currentLabel.split("-");
        monthLabel.innerText = new Date(y, m - 1).toLocaleString("en-IN", {
          month: "long",
          year: "numeric"
        });
      } else if (range === "6months") {
        monthLabel.innerText = "Last 6 Months";
      } else {
        monthLabel.innerText = "Year " + currentLabel.split("-")[0];
      }

      monthSaving.innerText = "â‚¹ " + currentSavings.toLocaleString();

      const rate = currentIncome > 0
        ? Math.round((currentSavings / currentIncome) * 100)
        : 0;

      savingRate.innerText = "Savings Rate: " + rate + "%";
      /* ===== INSIGHT (DYNAMIC & CHANGING) ===== */
let insight = "";

if (range === "month") {
  if (last > 0) {
    const prev = data.savings_list[last - 1] || 0;
    const diff = currentSavings - prev;

    if (diff > 0) {
      insight = `ðŸ“ˆ Savings increased by â‚¹${diff.toLocaleString()} compared to last month`;
    } else if (diff < 0) {
      insight = `ðŸ“‰ Savings decreased by â‚¹${Math.abs(diff).toLocaleString()} compared to last month`;
    } else {
      insight = "âž– Savings remained the same as last month";
    }
  } else {
    insight = "â„¹ Not enough data to compare with previous month";
  }

} else if (range === "6months") {
  insight =
    rate >= 50
      ? "âœ… Strong savings performance over the last 6 months"
      : "âš  Savings are low in the last 6 months, expenses may be high";

} else if (range === "year") {
  insight =
    rate >= 50
      ? "ðŸ’ª Good yearly savings discipline"
      : "âš  Yearly savings rate is low, review expenses";
}

insightText.innerText = insight;


      chart.data.labels = data.labels;
      chart.data.datasets[0].data = data.incomes;
      chart.data.datasets[1].data = data.expenses;
      chart.data.datasets[2].data = data.savings_list;
      chart.update();
    });
}

const ctx = document.getElementById("savingsChart");

chart = new Chart(ctx, {
  type: "bar",
  data: {
    labels: [],
    datasets: [
      { label: "Income",   backgroundColor: "#4f7cff", data: [] },
      { label: "Expenses", backgroundColor: "#ff6b6b", data: [] },
      { label: "Savings",  backgroundColor: "#4caf50", data: [] }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false
  }
});

loadSavings("6months");
</script>

</body>
</html>
